---
title: "Xenium mouse brain - three replicates"
author: "Melody Jin"
date: "2025-09-08"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
editor_options:
  chunk_output_type: console
---

```{r global-options, include = FALSE}
options(width = 80 , digits = 3) # output length

knitr::opts_chunk$set(cache = FALSE,echo = TRUE,prompt = FALSE, 
                      comment = NA,message = FALSE,warning = FALSE,
                      fig.align = "center", fig.keep= "all",fig.show ="hold")

```

```{r load-lib}
library(jazzPanda)
library(SpatialExperiment)
library(Seurat)
library(ggplot2)
library(data.table)
library(dplyr)
library(glmnet)
library(caret)
library(ComplexUpset)
library(ggrepel)
library(gridExtra)
library(patchwork)
library(RColorBrewer)
library(limma)
library(here)
library(tidyr)
library(xtable)
source(here("scripts/utils.R"))
```

# Load the data
```{r load-raw}
rep1=get_xenium_data(path="/vast/projects/xenium_5k/data/jazzPanda_paper_dataset/Xenium_mouse_brain/Xenium_V1_FF_Mouse_Brain_MultiSection_1_outs/", 
                     mtx_name = "cell_feature_matrix/",
                     trans_name = "transcripts.csv.gz",
                     cells_name="cells.csv.gz")

rep2=get_xenium_data(path="/vast/projects/xenium_5k/data/jazzPanda_paper_dataset/Xenium_mouse_brain/Xenium_V1_FF_Mouse_Brain_MultiSection_2_outs/", 
                     mtx_name = "cell_feature_matrix/",
                     trans_name = "transcripts.csv.gz",
                     cells_name="cells.csv.gz")

rep3=get_xenium_data(path="/vast/projects/xenium_5k/data/jazzPanda_paper_dataset/Xenium_mouse_brain/Xenium_V1_FF_Mouse_Brain_MultiSection_3_outs/", 
                     mtx_name = "cell_feature_matrix/",
                     trans_name = "transcripts.csv.gz",
                     cells_name="cells.csv.gz")

rep1$trans_info = rep1$trans_info[rep1$trans_info$qv >=20 & rep1$trans_info$cell_id != -1 & !(rep1$trans_info$cell_id %in% rep1$zero_cells), ]
rep2$trans_info = rep2$trans_info[rep2$trans_info$qv >=20 &  rep2$trans_info$cell_id != -1 & !(rep2$trans_info$cell_id %in% rep2$zero_cells), ]
rep3$trans_info = rep3$trans_info[rep3$trans_info$qv >=20 & rep3$trans_info$cell_id != -1 & !(rep3$trans_info$cell_id %in% rep3$zero_cells), ]

data_nm  <- "xenium_mbrain"
# load generated data
cluster_info = readRDS(here(data_path,paste0(data_nm, "_clusters.Rds")))
cluster_names = paste0("c",1:9)

anno_df <- data.frame(
    cluster = cluster_names,
    major_class = c(
    "Inhibitory neuron",
    "Oligodendrocyte lineage",
    "Excitatory neuron",
    "Excitatory neuron",
    "Non-neuronal (barrier/stromal mix)",
    "Inhibitory projection neuron",
    "Excitatory neuron",
    "Excitatory neuron",
    "Cholinergic neuron"
  ),
  sub_class = c(
    "L2/3 LAMP5/VIP interneuron",
    "Mature oligodendrocyte (myelinating)",
    "IT L2/3",
    "Corticothalamic-like",
    "Choroid plexus & vascular/stromal admixture",
    "Striatal medium spiny neuron (MSN)",
    "Dentate gyrus granule",
    "IT L6 corticocortical (Neurod6+)",
    "Cortical/striatal cholinergic interneuron"
  ),
  cell_type = c(
    "VIP/LAMP5 (CPLX3+, ID2+)",
    "MOL (Opalin+/Gjc3+/Sox10+)",
    "IT-L2/3 (BHLHE22+/HPcal1+)",
    "L6 CT-like (FOXP2+/NTSR2+/VGlut2+)",
    "Choroid plexus epithelium–enriched",
    "MSN (DARPP-32+, GABAergic)",
    "DG granule (Prox1+/Calb1+)",
    "IT-L6/CC (Neurod6+/Wfs1+/Shisa6+)",
    "ChAT+/SNCG+ interneuron"
  ),
  supporting_genes = c(
    "JP: Id2, Lamp5, Vip, Cplx3, Crh, Cort; FM: Lamp5, Vip, Cplx3, Satb2",
    "JP: Opalin, Gjc3, Sox10; FM: Opalin, Sox10, Gjc3, Spag16",
    "JP: Slc17a7, Bhlhe22, Hpcal1, Cdh13; FM: Cabp7, Bhlhe22, Syt17",
    "JP: Slc17a6, Foxp2, Ntsr2, Rims3; FM: Slc17a6, Foxp2, Rims3",
    "JP: Igf2, Slc13a4, Kdr, Pecam1, Emcn, Col1a1, Acta2; FM: Fmod, Aldh1a2, Igf2, Col1a1, Spp1",
    "JP: Ppp1r1b, Gad1/2, Penk, Pdyn, Meis2; FM: Penk, Pdyn, Ppp1r1b, Gad2",
    "JP: Prox1, Calb1, Prdm8; FM: Prox1, Calb1",
    "JP: Neurod6, Wfs1, Shisa6, Igfbp4; FM: Neurod6, Pou3f1, Shisa6, Wfs1",
    "JP: Chat, Sncg, Syt6; FM: Chat, Sncg, Tacr1, Kctd8"
  ),
  notes = c(
    "Robust LAMP5/VIP signal (Id2/Lamp5/Cplx3). SATB2/CUX2 likely ambient; minor immune genes likely contamination.",
    "Opalin+Gjc3+Sox10 define mature oligos; low Gpr17 argues against OPC.",
    "Slc17a7+ with IT adhesion/signaling genes; endothelial/immune hits in FM likely contaminants.",
    "Foxp2+Ntsr2+ with Slc17a6 (VGlut2) suggest L6 corticothalamic-like; some L4/5 IT (Rorb) admixture.",
    "Strong CP markers (Igf2, Slc13a4) with endothelial/smc/fibro mix → perivascular/meningeal CP neighborhood; ependymal Trp73 low.",
    "Classic MSN signature (DARPP-32 + Gad1/2 + Penk/Pdyn); indicates striatal tissue present.",
    "Prox1 hallmark of DG granule; Calb1 supportive.",
    "Canonical Neurod6 IT-L6 corticocortical program; small PT marker bleed-through possible.",
    "Clear ChAT/SNCG cholinergic identity; Syt6 hints at small L6 CT admixture."
  ),
  anno_name=c(
  "Inh_L23_LAMP5_VIP",        
  "Oligo_Mature_MOL",         
  "Exc_L23_IT",               
  "Exc_L6_CTlike",            
  "NonNeur_CP_VascStromal",   
  "Inh_Striatal_MSN",         
  "Exc_DG_Granule",           
  "Exc_L6_IT_CC",            
  "Cholin_ChAT_SNCG"),
  confidence = c(
    "Medium-High",
    "High",
    "Medium",
    "Medium",
    "Medium-Low",
    "High",
    "High",
    "Medium-High",
    "High"
  ),
  stringsAsFactors = FALSE
)


cluster_info = merge(cluster_info, anno_df, by="cluster")

cluster_info$cluster = factor(cluster_info$cluster,
                              levels=cluster_names)
# cluster_info = cluster_info[order(cluster_info$cluster), ]

cluster_info$anno_name = factor(cluster_info$anno_name,
                              levels=anno_df$anno_name)
cluster_info = cluster_info[order(cluster_info$anno_name), ]


jazzPanda_res_lst = readRDS(here(data_path,paste0(data_nm, "_jazzPanda_res_lst.Rds")))
fit.cont = readRDS(here(data_path,paste0(data_nm, "_fit_cont_obj.Rds")))
FM_result= readRDS(here(data_path,paste0(data_nm, "_seu_markers.Rds")))
sv_lst = readRDS(here(data_path,paste0(data_nm, "_sq50_vector_lst.Rds")))
seu = readRDS(here(data_path,paste0(data_nm, "_seu.Rds")))
se = readRDS(here(data_path,paste0(data_nm, "_se.Rds")))
nbins = 2500
Idents(seu)=cluster_info$anno_name[match(colnames(seu), cluster_info$cell_id)]
seu$sample = cluster_info$sample[match(colnames(seu), cluster_info$cell_id)]

```

# Dataset overview
```{r}

    
plot_data_sp(cluster_info=cluster_info,file_prefix = data_nm, height = 700,
             my_colors = my_colors, ct_nm = "anno_name", 
             fig_ratio = 7365 / 10117)
plot_cluster_props(cluster_info=cluster_info,file_prefix = data_nm, 
                   my_colors = my_colors, ct_nm = "anno_name")


umap_bkm <- as.data.frame(reducedDim(se, "UMAP_M1_lam0.2"))
umap_bkm$cluster <- paste0("c", colData(se)$clust_M1_lam0.2_k50_res0.1)
umap_bkm$sample_id <- se$sample_id  
umap_bkm$anno_name <- cluster_info$anno_name[match(row.names(umap_bkm),
                                                 cluster_info$cell_id)]
umap_bkm$anno_name =factor(umap_bkm$anno_name, 
                           levels = anno_df$anno_name)
umap_bkm = umap_bkm[order(umap_bkm$anno_name), ]
label_df <- umap_bkm %>%
    group_by(cluster, sample_id) %>%
    summarise(V1 = mean(V1), V2 = mean(V2), .groups = "drop")


rm(se)

out_file <- here(overview_PA, paste0(data_nm, "_UMAP", ".jpg"))
jpeg(out_file, width=1000*3, height=1000, res=200)

ggplot(umap_bkm, aes(x = V1, y = V2, color = anno_name)) +
    ggrastr::geom_point_rast(size = 0.01, alpha = 0.8) +
    defined_theme +
    facet_wrap(~sample_id, nrow=1)+
    scale_color_manual(values = my_colors)+
    guides(color = guide_legend(override.aes = list(size = 3), 
                                ncol = 1, title = "")) +
    labs(title = " ", x = "UMAP1", y = "UMAP2", fill=" ") +
    theme(strip.background = element_blank(),
          strip.text = element_text(size = 20, face = "plain"),
          legend.position = "right",
          legend.text = element_text(size = 12),
          panel.border = element_rect(colour = "black", 
                                      fill = NA, linewidth = 0.3),
          axis.line = element_blank(),
          legend.justification = "center",
          axis.ticks = element_blank(),
          legend.box.just = "center", 
          axis.text = element_blank(),
          axis.title = element_blank())
dev.off()
```

# Spatial pattern of negative controls
```{r falsecode, fig.width=10, fig.height=10}

nc_sp1 <- rep1$trans_info %>% 
    filter(feature_name %in% c(rep1$probe, rep1$codeword)) %>% 
    mutate(sample = "replicate1", 
           category = ifelse(feature_name %in% rep1$codeword, 
                             "negative control codeword",
                             "negative control probe"))

nc_sp2 <- rep2$trans_info %>% 
    filter(feature_name %in% c(rep2$probe, rep2$codeword)) %>% 
    mutate(sample = "replicate2", 
           category = ifelse(feature_name %in% rep2$codeword, 
                             "negative control codeword",
                             "negative control probe"))


nc_sp3 <- rep3$trans_info %>% 
    filter(feature_name %in% c(rep3$probe, rep3$codeword)) %>% 
    mutate(sample = "replicate3", 
           category = ifelse(feature_name %in% rep3$codeword, 
                             "negative control codeword",
                             "negative control probe"))

# Xenium negative control category 
bins_map <- list("negative control probe" = 1,
                 "negative control codeword" = 1) 


for (cat in unique(nc_sp1$category)) {
  plot_nc(nc_sp1, "replicate1", cat, data_nm, overview_PA,
          fig_ratio = 7365 / 10117,
          bins_map = bins_map, width = 1000, height = 800)
}

for (cat in unique(nc_sp2$category)) {
  plot_nc(nc_sp2, "replicate2", cat, data_nm, overview_PA,
          fig_ratio = 7365 / 10117,
          bins_map = bins_map, width = 1000, height = 800)
}

for (cat in unique(nc_sp3$category)) {
  plot_nc(nc_sp3, "replicate3", cat, data_nm, overview_PA,
          fig_ratio = 7365 / 10117,
          bins_map = bins_map, width = 1000, height = 800)
}

```

# jazzPanda-glm
```{r jazzPanda-glm}
jazzPanda_res = get_top_mg(jazzPanda_res_lst, coef_cutoff=0.1)  
jazzPanda_summary = as.data.frame(table(jazzPanda_res$top_cluster))
colnames(jazzPanda_summary) = c("cluster","jazzPanda_glm")
```

```{r, output_markergenes, eval=FALSE}

# Combine into a new dataframe for LaTeX output
output_data <- do.call(rbind, lapply(cluster_names, function(cl) {
  subset <- jazzPanda_res[jazzPanda_res$top_cluster == cl, ]
  sorted_subset <- subset[order(-subset$glm_coef), ]
  gene_list <- paste(sorted_subset$gene, "(", round(sorted_subset$glm_coef, 2), ")", sep="", collapse=", ")
 
  return(data.frame(Cluster = cl, Genes = gene_list))
}))

latex_table <- xtable(output_data, caption="Detected marker genes for each cluster by jazzPanda, in decreasing value of glm coefficients")
print.xtable(latex_table, include.rownames = FALSE, hline.after = c(-1, 0, nrow(output_data)), comment = FALSE)
```

## Top3 marker genes by jazzPanda-glm
```{r  top3-gene-vis-xy, fig.width=10, fig.height=6}
x_range <- c(0, 11000)
y_range <- c(0, 7500)

plot_lst=list()
for (cl in cluster_names){
    ct_nm = anno_df[anno_df$cluster==cl, "anno_name"]
    inters=jazzPanda_res[jazzPanda_res$top_cluster==cl,"gene"]
    rounded_val=signif(as.numeric(jazzPanda_res[inters,"glm_coef"]),
                          digits = 3)
    inters_df = as.data.frame(cbind(gene=inters, value=rounded_val))
    inters_df$value = as.numeric(inters_df$value)
    inters_df=inters_df[order(inters_df$value, decreasing = TRUE),]
    inters_df$text= paste(inters_df$gene,inters_df$value,sep=": ")
    
    if (length(inters > 0)){
        inters_df = inters_df[1:min(3, nrow(inters_df)),]
        inters = inters_df$gene
        all_trans = as.data.frame(matrix(0, ncol=6))
        colnames(all_trans) = c("x","y", "feature_name","value","text_label","sample")
        for (rp in c("rep1","rep2","rep3")){
          rp_lst = get(rp)
          iters_sp1= rp_lst$trans_info$feature_name %in% inters
          vis_r1 =rp_lst$trans_info[iters_sp1,
                            c("x","y","feature_name")]
          vis_r1$value = inters_df[match(vis_r1$feature_name,inters_df$gene),
                            "value"]
          vis_r1=vis_r1[order(vis_r1$value,decreasing = TRUE),]
          vis_r1$text_label= paste(vis_r1$feature_name,
                                vis_r1$value,sep=": ")
          vis_r1$text_label=factor(vis_r1$text_label, levels=inters_df$text)
          vis_r1$sample=paste("replicate", substr(rp,start = 4, stop=4),sep="")
          all_trans = rbind(all_trans,vis_r1)
        }
        all_trans = all_trans[2:nrow(all_trans),]
        all_trans$text_label = factor(all_trans$text_label, 
                                      levels = inters_df$text)
        all_trans = all_trans[order(all_trans$text_label),]

        genes_plt<- ggplot(data = all_trans,
                    aes(x = x, y = y))+ 
                    #geom_point(size=0.0001)+
                    geom_hex(bins = auto_hex_bin(mean(table(all_trans$sample, 
                                                            all_trans$feature_name))))+
                    facet_grid(sample~text_label)+
                    scale_x_reverse() +
                    scale_fill_gradient(low="white", high="maroon4") + 
                    #scale_color_manual(values = c("maroon4","maroon4","maroon4"))+
                    guides(fill = guide_colorbar(barheight = unit(0.2, "npc"), 
                                                 barwidth  = unit(0.03, "npc")))+
                    defined_theme+
            theme(legend.position = "right", 
              strip.background = element_rect(fill =NA,colour = NA),
              strip.text = element_text(size = rel(1.3)), 
              strip.text.y.right = element_blank(),
              legend.key.width = unit(2, "cm"),
              aspect.ratio = 7365 / 10117,
              legend.title = element_text(size = 10),
              legend.text = element_text(size = 10),
               legend.key.height = unit(2, "cm"))
        
        cluster_data =  cluster_info[cluster_info$cluster==cl, ]
        cluster_data$label = paste(cluster_data$sample, cluster_data$anno_name, sep="-")
        cluster_data$label =factor(cluster_data$label, 
                                   levels=paste(paste("replicate",1:3,sep=""),
                                                ct_nm,sep="-"))
        p_cl<- ggplot(data =cluster_data,
                    aes(x = x, y = y, color=sample))+ 
                    #geom_hex(bins = 100)+
                    geom_point(size=0.01)+
                    facet_wrap(~label, nrow=3,strip.position = "left")+
                    scale_x_reverse(limits = rev(x_range)) +  # enforce global x
                    scale_y_continuous(limits = y_range) +  # enforce global y

                    scale_color_manual(values = c("black","black","black"))+
                    defined_theme + 
            theme(legend.position = "none", 
                  strip.background = element_blank(), 
                  aspect.ratio = 7365 / 10117,
                  legend.key.width = unit(15, "cm"),
                  strip.text = element_text(size = rel(1.2)))

        lyt <-p_cl | genes_plt
        layout_design <- lyt + patchwork::plot_layout(heights = c(1,1),widths = c(1, 3)) 
        cat("cluster:", cl,"\n")
        jpeg(file.path(mg_PA,paste0(data_nm, "_glm_", cl,"_top3.jpg")),
             width=800*4, height=650*3, res=200)
        print(layout_design)
        dev.off()
    }
  }


```
## cluster vector versus marker gene vector 
```{r}
plot_lst=list()
for (cl in cluster_names){
    ct_nm = anno_df[anno_df$cluster==cl, "anno_name"]
    inters_df=jazzPanda_res[jazzPanda_res$top_cluster==cl,]

    inters_df=inters_df[order(inters_df$glm_coef, decreasing = TRUE),]
    
    inters_df = inters_df[1:min(3, nrow(inters_df)),]
    mk_genes = inters_df$gene

    dff = as.data.frame(cbind(sv_lst$cluster_mt[,cl],
                              sv_lst$gene_mt[,mk_genes]))
    colnames(dff) = c("cluster", mk_genes)
    dff$sample= "replicate1"
    dff[nbins:(nbins*2),"sample"] = "replicate2"
    dff[(nbins*2):(nbins*3),"sample"] = "replicate3"
    dff$vector_id = c(1:nbins, 1:nbins, 1:nbins)
    long_df <- dff %>% 
    pivot_longer(cols = -c(cluster, sample, vector_id), names_to = "gene", 
               values_to = "vector_count")
    long_df$gene = factor(long_df$gene, levels=mk_genes)
    long_df$sample = factor(long_df$sample , 
                        levels=c("replicate1","replicate2", "replicate3"))
    p<-ggplot(long_df, aes(x = cluster, y = vector_count, color=gene )) +
    geom_point(size=0.01) +
    facet_grid(sample~gene, scales="free_y") +
    labs(x = paste(ct_nm, " cluster vector ", sep=""), 
         y = "Top3 marker gene vector") +
    theme_minimal()+
        scale_y_continuous(expand = c(0.01,0.01))+ 
        scale_x_continuous(expand =  c(0.01,0.01))+ 
        theme(panel.grid = element_blank(),legend.position = "none",
        strip.text = element_text(size = 12),
        axis.line=element_blank(),
        axis.text=element_text(size = 11),
        axis.ticks=element_line(color="black"),
        axis.title=element_text(size = 13),
        panel.border  =element_rect(colour = "black", 
                                    fill=NA, linewidth=0.5)
        )
    plot_lst[[cl]] = p
}


n_per_page <- 6
rem <- length(plot_lst) %% n_per_page
if (rem != 0) {
  n_pad <- n_per_page - rem
  plot_lst <- c(
    plot_lst,
    rep(list(patchwork::plot_spacer()), n_pad)
  )
}

# Split into 2×2 pages
plot_chunks <- split(plot_lst, ceiling(seq_along(plot_lst) / n_per_page))

pdf(file.path(mg_PA, paste0(data_nm, "_glm_mg_vvplot.pdf")),
    height = 12, width = 12)

for (chunk in plot_chunks) {
  # arrange 2 columns, auto rows
   p <- wrap_plots(chunk, ncol = 2) +
       plot_layout(heights = c(1,1,1), widths = c(1,1))
  print(p)
}

dev.off()

```


## Wilcoxon Rank Sum Test

The `FindAllMarkers` function applies a Wilcoxon Rank Sum test to detect genes with cluster-specific expression shifts. Only positive markers (upregulated genes) were retained using a log fold-change threshold of 0.25.

```{r fm-mg,eval=FALSE}
table(FM_result$cluster)

FM_result$cluster <- factor(FM_result$cluster, levels = cluster_names)

top_mg <- FM_result %>%
  group_by(cluster) %>%
  arrange(desc(avg_log2FC), .by_group = TRUE) %>% 
  slice_max(order_by = avg_log2FC, n = 20) %>%
  select(cluster, gene, avg_log2FC)
uni_clusters <-cluster_names

# Combine into a new dataframe for LaTeX output
output_data <- do.call(rbind, lapply(uni_clusters, function(cl) {
  subset <- top_mg[top_mg$cluster == cl, ]
  sorted_subset <- subset[order(-subset$avg_log2FC), ]
  gene_list <- paste(sorted_subset$gene, "(", round(sorted_subset$avg_log2FC, 2), ")", sep="", collapse=", ")
 
  return(data.frame(Cluster = cl, Genes = gene_list))
}))

latex_table <- xtable(output_data, caption="Detected marker genes for each cluster by FindMarkers")
print.xtable(latex_table, include.rownames = FALSE, hline.after = c(-1, 0, nrow(output_data)), comment = FALSE)
```


# Compare marker genes by different methods
```{r limma-mg}
limma_dt <- decideTests(fit.cont)
summary(limma_dt)
```

# Comparison of marker gene detection methods
## Cumulative rank plot

We compared the performance of different marker detection methods — jazzPanda (linear modelling and correlation), limma, and Seurat’s Wilcoxon Rank Sum test — by plotting the cumulative fraction of genes with strong spatial correlation (Pearson’s ρ > 0.6) as a function of their rank within each method.

```{r}
plot_lst=list()

cor1 <- cor(sv_lst$gene_mt[1:2500, ],
            sv_lst$cluster_mt[1:2500, cluster_names], method = "spearman")

cor2 <- cor(sv_lst$gene_mt[2500:5000, ],
            sv_lst$cluster_mt[2500:5000, cluster_names], method = "spearman")

cor3 <- cor(sv_lst$gene_mt[5000:7500, ],
            sv_lst$cluster_mt[5000:7500, cluster_names], method = "spearman")

cor_M <-(cor1 + cor2 + cor3) / 3


Idents(seu)=cluster_info$cluster[match(colnames(seu), cluster_info$cell_id)]
for (cl in cluster_names){
    ct_nm = anno_df[anno_df$cluster==cl, "anno_name"]
    fm_cl=FindMarkers(seu, ident.1 = cl, only.pos = TRUE,
            logfc.threshold = 0.1)
    fm_cl = fm_cl[fm_cl$p_val_adj<0.05, ]
    fm_cl = fm_cl[order(fm_cl$avg_log2FC, decreasing = TRUE),]
    to_plot_fm =row.names(fm_cl)

    
    limma_cl<-topTable(fit.cont,coef=cl,p.value = 0.05, n=Inf, sort.by = "p")
    limma_cl = limma_cl[limma_cl$logFC>0, ]
    to_plot_lm = row.names(limma_cl)
    
    
    lasso_sig = jazzPanda_res[jazzPanda_res$top_cluster==cl,]
    lasso_sig = lasso_sig[order(lasso_sig$glm_coef, decreasing = TRUE),]
    
    FM_pt = data.frame("name"=to_plot_fm,"rk"= 1:length(to_plot_fm),
                       "y"= get_cmr_ma(to_plot_fm,cor_M = cor_M, cl = cl),
                       "type"="Wilcoxon Rank Sum Test")
    
    
    lasso_pt = data.frame("name"=lasso_sig$gene,"rk"= 1:nrow(lasso_sig),
                          "y"= get_cmr_ma(lasso_sig$gene,cor_M = cor_M, cl = cl),
                          "type"="jazzPanda-glm")
    
    limma_pt = data.frame("name"=to_plot_lm,"rk"= 1:length(to_plot_lm),
                          "y"= get_cmr_ma(to_plot_lm,cor_M = cor_M, cl = cl),
                          "type"="limma")
  
    data_lst = rbind(limma_pt, lasso_pt,FM_pt)

    data_lst$type <- factor(
        data_lst$type,
        levels = c("jazzPanda-glm", "limma", "Wilcoxon Rank Sum Test")
    )
    data_lst$rk = as.numeric(data_lst$rk)
    p <-ggplot(data_lst, aes(x = rk, y = y, color = type)) +
        geom_step(size = 0.8) +  # type = "s"
        scale_color_manual(values = c("jazzPanda-glm" = "red",
                                      "limma" = "black",
                                      "Wilcoxon Rank Sum Test" = "blue")) +
        labs(title = ct_nm, x = "Rank of marker genes",
             y = "Cumulative average correlation",
             color = NULL) +
        scale_x_continuous(limits = c(0, 50))+
        theme_classic(base_size = 12) +
        theme(plot.title = element_text(hjust = 0.5),
            axis.line = element_blank(),  
            panel.border = element_rect(color = "black", 
                                        fill = NA, linewidth = 1),
            legend.position = "inside",
            legend.position.inside = c(0.98, 0.02),
            legend.justification = c("right", "bottom"),
            legend.background = element_rect(color = "black", 
                                             fill = "white", linewidth = 0.5),
            legend.box.background = element_rect(color = "black",
                                                 linewidth = 0.5)
        )
    plot_lst[[cl]] <- p
}

combined_plot <- wrap_plots(plot_lst, ncol = 3)
pdf(file.path(comp_PA, paste0(data_nm, "_mg_compare_rank.pdf")),
    height = 15, width = 15)
combined_plot 
dev.off()

```

## Upset plot

We further visualized the overlap between marker genes detected by the four methods using UpSet plots for each cluster. 

Across all clusters, jazzPanda-glm and jazzPanda-correlation consistently show the largest unique and shared marker sets, while classical tests (Wilcoxon and limma) detect far fewer genes. The highest intersections occur between the two jazzPanda models, indicating strong internal concordance and robust detection of spatially coherent markers.

```{r upset-mg-comparison, fig.width=12, fig.height=18}
plot_lst=list()
for (cl in cluster_names){
    ct_nm = anno_df[anno_df$cluster==cl, "anno_name"]
    findM_sig <- FM_result[FM_result$cluster==cl & FM_result$p_val_adj<0.05,"gene"]
    limma_sig <- row.names(limma_dt[limma_dt[,cl]==1,])
    lasso_cl <- jazzPanda_res[jazzPanda_res$top_cluster==cl, "gene"]
    df_mt <- as.data.frame(matrix(FALSE,nrow=nrow(jazzPanda_res),ncol=3))
    row.names(df_mt) <- jazzPanda_res$gene
    colnames(df_mt) <- c("jazzPanda-glm",
                      "Wilcoxon Rank Sum Test","limma")
    df_mt[findM_sig,"Wilcoxon Rank Sum Test"] <- TRUE
    df_mt[limma_sig,"limma"] <- TRUE
    df_mt[lasso_cl,"jazzPanda-glm"] <- TRUE
    
    df_mt$gene_name <- row.names(df_mt)
    
    p = plot(upset(df_mt,
               intersect=c("Wilcoxon Rank Sum Test", "limma",
                           "jazzPanda-glm"),
               wrap=TRUE, keep_empty_groups= FALSE, name="",
               #themes=theme_grey(),
               stripes='white',
               sort_intersections_by ="cardinality", sort_sets= FALSE,min_degree=1,
               set_sizes =( 
                   upset_set_size()
                   + theme(axis.title= element_blank(),
                           axis.ticks.y = element_blank(),
                           axis.text.y = element_blank())),
               sort_intersections= "descending", warn_when_converting=FALSE,
               warn_when_dropping_groups=TRUE,encode_sets=TRUE,

               width_ratio=0.3, height_ratio=1/4)+
              ggtitle(ct_nm)+
                 theme(plot.title = element_text( size=15))

    )
         
    plot_lst[[cl]] <- p 
}


combined_plot <- wrap_plots(plot_lst, ncol = 3)
pdf(file.path(comp_PA, paste0(data_nm, "_mg_compare_upset.pdf")),
     height =5* (ceiling(length(cluster_names)/3)), width = 19)
combined_plot 
dev.off()
```

```{r}
sessionInfo()
```
