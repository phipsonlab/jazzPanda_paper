---
title: "R Notebook"
output: html_notebook
---
# Discussion

## Effect of number of tiles on marker genes 
* bash file: `ntile_markergenes_sa.sh`
* R file: `ntile_markergene_result.R`
* result files: `csv files starts with complexity_ntiles`

## Time and memory complexity 

* number of cells
    * bash file: `cosmx_complexity_ncells.sh`
    * R file: `complexity-cosmx-hliver-cancer-ncells.R`
    * result files: `cosmx_hliver_cancer_comp_ncells_only.csv`

* number of genes
    * bash file: `complexity_ngenes_sa.sh`
    * R file: `complexity_ngenes_cosmx_hliver_cancer_slurmarray_temp.R`
    * result files: `csv files starts with complexity_ngene`
    
* number of tiles
    * bash file: `complexity_ntiles_sa.sh`
    * R file: `complexity_ntiles_cosmx_hliver_cancer_slurmarray_temp.R`
    * result files: `csv files starts with ntiles_mg_gr`


```{r}
library(dplyr) 
library(knitr)
library(ggplot2)
library(tidyr)
library(patchwork)
library(ComplexUpset)
library(xtable)
PA = "figures/main/figure6/"

```
# Computational complexity 
## Time and memory usage of analysed datasets
```{r}
cosmx_cancer = read.csv("./data/cosmx_human_liver_cancer_5core.csv")
cosmx_normal= read.csv("./data/cosmx_human_healthy_liver_5core.csv")
merscope_hbreast = read.csv("./data/merscope_human_breast_cancer_5core.csv")
xenium_mbrain =read.csv("./data/xenium_mouse_brain_5core.csv")
xenium_hbreast=read.csv("./data/xenium_human_breast_cancer_5core.csv")
xenium_hlung = read.csv("./data/xenium_human_lung_cancer_5core.csv")
update_resource_usage <- function(df) {
    df_long = reshape2::melt(df, 
                         id.var=c("technology","dataset", "genes_n",
                                      "transcript_n", "cells_n", "clusters_n",
                                      "grid_length"), variable.name="type", 
                         value.name="value")
    df_long$type = as.character(df_long$type)
    df_long$name=  sapply(df_long$type, function(x) strsplit(x, "_")[[1]][1])
    df_long$usage=   sapply(df_long$type, function(x) strsplit(x, "_")[[1]][2])
    df_long = df_long[,c("technology","dataset", "genes_n", "transcript_n",
                         "cells_n", "clusters_n", "grid_length", 
                         "value","name", "usage" )]
    df_wide <- df_long %>% pivot_wider(names_from = usage, 
                                       values_from = value )
    df_wide = as.data.frame(df_wide)
    df_wide$Elapsed = df_wide$Elapsed/60
    
    colnames(df_wide) = c("technology","dataset", "genes_n", "transcript_n",
                         "cells_n", "clusters_n", "grid_length", "name", "time_min","peak_memory_mb" )
    
    df_wide[df_wide$name=="glm","time_min"]=df_wide[df_wide$name=="glm","time_min"]+df_wide[df_wide$name=="sv","time_min"]
    df_wide[df_wide$name=="glm","peak_memory_mb"]=df_wide[df_wide$name=="glm","peak_memory_mb"]+df_wide[df_wide$name=="sv","peak_memory_mb"]
    df_wide = df_wide[df_wide$name != "sv", ]

  return(df_wide)
}

# Apply the function to each data frame
xenium_mbrain <- update_resource_usage(xenium_mbrain)
xenium_hlung <- update_resource_usage(xenium_hlung)
cosmx_cancer <- update_resource_usage(cosmx_cancer)
cosmx_normal <- update_resource_usage(cosmx_normal)

xenium_hbreast <- update_resource_usage(xenium_hbreast)
merscope_hbreast <- update_resource_usage(merscope_hbreast)

dff = rbind(xenium_hlung,cosmx_cancer,merscope_hbreast,
            cosmx_normal,xenium_mbrain, xenium_hbreast)
labels_refs = as.data.frame(cbind(name = c("perm","glm", "limma","fm"), 
                                  label = c("jazzPanda-correlation(5000 permutation)",
                                            "jazzPanda-glm",
                                            "limma","Wilcoxon Rank Sum tests")))
dff = merge(dff, labels_refs, by="name" )
dff$label = factor(dff$label,levels =labels_refs$label)

dff_data_summary <- dff %>%  distinct(dataset,.keep_all = TRUE) %>% 
    select(technology, dataset, genes_n,transcript_n, cells_n,  clusters_n)
dff_data_summary = dff_data_summary[order(dff_data_summary$transcript_n, decreasing = FALSE),]
xtable(dff_data_summary, format = "latex", 
       display = c("s","s","d","d","e","e","d"),
      caption = "tested datasets",  include.rownames=FALSE)
```

```{r memory complexity, fig.width=10, fig.height=4}
library(ggtext)
dff$dataset_info = paste0(dff$dataset,"<br>", "*", dff$cells_n, 
                          " cells <br>",dff$transcript_n," transcripts",
                          "*",  sep="")
dff$dataset_info = factor(dff$dataset_info, 
                     levels =paste0(dff_data_summary$dataset,"<br>", "*", 
                                    dff_data_summary$cells_n, 
                          " cells <br>",dff_data_summary$transcript_n,
                          " transcripts","*",  sep=""))
dff = dff[order(dff$dataset_info), ]
pdf(paste0(PA, "time_usage_per_dataset.pdf"), width=16, height=5)
ggplot(dff, aes(x = dataset_info, y = time_min, fill =label )) +
  geom_bar(stat = "identity", position = position_dodge())+
  theme_classic() +
  labs(title = "", x = "", y ="Time (min)", fill = " ") +
     guides(fill = guide_legend(nrow = 1, size=2))+
  scale_y_continuous(expand = c(0.02,0.02)) +
  theme(axis.text.y=element_text( vjust = 0.5, hjust=0.5, size=18),
        axis.text.x=element_markdown(angle=0, vjust = 0.5, hjust=0.5, size=12),
        legend.position = "top",
        axis.title.y =  element_text(size=18),
        legend.title = element_blank(), 
       legend.key.spacing.x= unit(1.5, 'cm'),     
        legend.text = element_text(size=15))

dev.off()

```

```{r memory-complexity-1, fig.width=10, fig.height=4}

pdf(paste0(PA, "memory_usage_per_dataset.pdf"), width=16, height=5)
ggplot(dff, aes(x = dataset_info, y = peak_memory_mb/1024, fill = label)) +
  geom_bar(stat = "identity", position = position_dodge())+
  theme_classic() +
  labs(title = "", x = "", y ="Memory (GB)", fill = " ") +
  scale_y_continuous(expand = c(0.02,0.02)) +
   theme(axis.text.y=element_text( vjust = 0.5, hjust=0.5, size=18),
        axis.text.x=element_markdown(angle=0, vjust = 0.5, hjust=0.5, size=12),
        legend.position = "top",
        axis.title.y =  element_text(size=18),
        legend.title = element_blank(), 
       legend.key.spacing.x= unit(1.5, 'cm'),     
        legend.text = element_text(size=15))
dev.off()
```
## Impact of increasing the number of transcripts 
```{r}
# get all slurm array results for ngenes
result_path <- "discussion_complexity/ngenes_result/"
files <- list.files(path = result_path, pattern = "\\.csv$", full.names = TRUE)
ngenes_df <- files %>% lapply(read.csv) %>% bind_rows()
```

```{r comp-ntr}

average_times <- ngenes_df %>%
  group_by(n_tr) %>%
  summarise(average_time_min_sv = mean(sv_Elapsed_Time_sec/60),
            average_time_min_glm = mean(glm_Elapsed_Time_sec/60), 
            transcript_n_log = log10(mean(transcript_n)), .groups = "drop") %>%
   pivot_longer(cols = c(average_time_min_sv,average_time_min_glm),
               names_to = "category",
               values_to = "avg_time",
               names_prefix = "average_time_min_")
average_times[average_times$category=="glm","category"] = "linear modelling"
average_times[average_times$category=="sv","category"] = "create spatial vectors"
average_times$category = factor(average_times$category, 
                                levels=c("create spatial vectors","linear modelling"))
average_memory <- ngenes_df %>%
  group_by(n_tr) %>%
  summarise(average_memory_sv = mean(sv_Peak_RAM_Used_MiB/1024),
            average_memory_glm = mean(glm_Peak_RAM_Used_MiB/1024),
             transcript_n_log =  log10(mean(transcript_n)), .groups = "drop")%>%
  pivot_longer(cols = c(average_memory_sv,average_memory_glm),
               names_to = "category",
               values_to = "avg_memory",
               names_prefix = "average_memory_")

average_memory[average_memory$category=="glm","category"] = "linear modelling"
average_memory[average_memory$category=="sv","category"] = "create spatial vectors"
average_memory$category = factor(average_memory$category, levels=c("create spatial vectors","linear modelling"))


p1<- ggplot(average_times, aes(x = transcript_n_log, y = avg_time, color=category)) +
    geom_point(size = 2) +
   # geom_smooth(method = "lm",se = FALSE, color = "steelblue")+
    theme_classic() +
    scale_y_continuous(limits =c(0,80), labels = seq(0,80,10), breaks =seq(0,80,10) )+
   scale_x_continuous(breaks = seq(6,10,by=1),labels=as.character(seq(6,10, by=1)))+
    labs(title = "Time usage",  x = expression("log10(number of transcripts)"), 
         y = "Average Time (min)") +
    theme(axis.text.x = element_text(size=15, angle=0, vjust=0.5),
          axis.title.x = element_text(size=15),
          legend.title=element_blank(),
          legend.position = "right",   
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 18, face = "bold"),
          axis.title.y = element_text(size=15))

p2<- ggplot(average_memory, aes(x = transcript_n_log, y = avg_memory, color=category)) +
    geom_point(size = 2) +
    theme_classic() +
   #scale_y_continuous(limits =c(0,30,10), labels = seq(0,30,10), breaks =seq(0,30,10) )+
    scale_x_continuous(breaks = seq(6,10,by=1),labels=as.character(seq(6,10, by=1)))+
    #scale_x_continuous(  breaks = seq(100,1000, 100),labels =seq(100, 1000, 100))+
    labs(title = "Memory usage", x = expression("log10(number of transcripts)"), 
         y = "Average Peak Memory (GiB)") +
    theme(axis.text.x = element_text(size=15, angle=0, vjust=0.5),
          axis.title.y = element_text(size=15), legend.title = element_blank(),
          axis.text.y = element_text(size=15),legend.position = "none",
          plot.title = element_text(size = 18, face = "bold"),
          axis.title.x = element_text(size=15))

 lyt <- p1 | p2
layout_design <-lyt + patchwork::plot_layout(heights = c(1,1), widths = c(1, 1), guides = "collect")&
    theme(legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size=15),
        legend.box.just = "center")

pdf(paste(PA, "complexity_ntr.pdf", sep=""),width = 12, height=5)
print(layout_design)
dev.off()

```
## Impact of increasing the number of tiles for hex bins 
```{r}
library(spatstat.geom)

# get all slurm array results for ngenes
result_path <- "discussion_complexity/ntiles_hexbin_result/"
files <- list.files(path = result_path, pattern = "\\.csv$", full.names = TRUE)
nhex_df <- files %>% lapply(read.csv) %>% bind_rows()

side_lengths <- c(620, 310, 207, 155, 124, 103, 89, 78)

n_bins_vec <- sapply(side_lengths, function(s) {
  H <- hextess(owin(c(0, 10000), c(0, 10000)), s)
  length(H$tiles)
})

map_df = data.frame(grid_length = side_lengths,
                    n_bins = n_bins_vec)

nhex_df = merge(nhex_df, map_df, by="grid_length")
nhex_df = nhex_df[nhex_df$grid_length %in% side_lengths, ]


```

```{r comp-ntr-hex}

average_times <- nhex_df %>%
  group_by(n_bins) %>%
  summarise(average_time_min_sv = median(sv_Elapsed_Time_sec/60),
            average_time_min_glm = median(glm_Elapsed_Time_sec/60),
            .groups = "drop") %>%
   pivot_longer(cols = c(average_time_min_sv,average_time_min_glm),
               names_to = "category",
               values_to = "avg_time",
               names_prefix = "average_time_min_")
average_times[average_times$category=="glm","category"] = "linear modelling"
average_times[average_times$category=="sv","category"] = "create spatial vectors"
average_times$category = factor(average_times$category, 
                                levels=c("create spatial vectors","linear modelling"))
average_memory <- nhex_df %>%
  group_by(n_bins) %>%
  summarise(average_memory_sv = median(sv_Peak_RAM_Used_MiB/1024),
            average_memory_glm = median(glm_Peak_RAM_Used_MiB/1024),
            .groups = "drop")%>%
  pivot_longer(cols = c(average_memory_sv,average_memory_glm),
               names_to = "category",
               values_to = "avg_memory",
               names_prefix = "average_memory_")

average_memory[average_memory$category=="glm","category"] = "linear modelling"
average_memory[average_memory$category=="sv","category"] = "create spatial vectors"
average_memory$category = factor(average_memory$category, levels=c("create spatial vectors","linear modelling"))


p1<- ggplot(average_times, aes(x = n_bins, y = avg_time, color=category)) +
    geom_point(size = 2) +
   # geom_smooth(method = "lm",se = FALSE, color = "steelblue")+
    theme_classic() +
    scale_y_continuous(limits =c(0,450), labels = seq(0,450,100), 
                       breaks =seq(0,450,100))+
   scale_x_continuous(limits = c(100, 10000),
                       breaks=c(100,seq(1000, 10000, 1000)),
                      labels=as.character(c(100,seq(1000, 10000, 1000))))+
    labs(title = "Time usage",  x = "Hex bin length", 
         y = "Average Time (min)") +
    theme(axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=0.9),
          axis.title.x = element_text(size=15),
          legend.title=element_blank(),
          legend.position = "right",   
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 18, face = "bold"),
          axis.title.y = element_text(size=15))

p2<- ggplot(average_memory, aes(x = n_bins, y = avg_memory, color=category)) +
    geom_point(size = 2) +
    theme_classic() +
    scale_y_continuous(limits =c(0,5,1), labels = seq(0,5,1), breaks =seq(0,5,1) )+
    scale_x_continuous(limits = c(100, 10000),
                       breaks=c(100,seq(1000, 10000, 1000)),
                      labels=as.character(c(100,seq(1000, 10000, 1000))))+
    #scale_x_continuous(  breaks = seq(100,1000, 100),labels =seq(100, 1000, 100))+
    labs(title = "Memory usage", x =  "Hex bin length",
         y = "Average Peak Memory (GiB)") +
    theme(axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=0.9),
          axis.title.y = element_text(size=15), legend.title = element_blank(),
          axis.text.y = element_text(size=15),legend.position = "none",
          plot.title = element_text(size = 18, face = "bold"),
          axis.title.x = element_text(size=15))

 lyt <- p1 | p2
layout_design <-lyt + patchwork::plot_layout(heights = c(1,1), widths = c(1, 1), guides = "collect")&
    theme(legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size=15),
        legend.box.just = "center")

pdf(paste(PA, "complexity_ntiles_hexbin.pdf", sep=""),width = 12, height=5)
print(layout_design)
dev.off()

```

## Impact of increasing the number of tiles used to create spatial vectors 
```{r}
# get all slurm array results for ntiles
result_path <- "discussion_complexity/ntiles_slurm_result/"
files <- list.files(path = result_path, pattern = "\\.csv$", full.names = TRUE)
ntiles_df <- files %>% lapply(read.csv) %>% bind_rows()

map_df = data.frame(grid_length = seq(10, 100, 10),
                    n_bins = c( seq(10, 100, 10)^2))

ntiles_df = merge(ntiles_df, map_df, by="grid_length")
```

```{r}
average_memory <- ntiles_df %>% 
    group_by(grid_length,n_bins) %>%
  summarise(sv_average_memory_GiB= mean(sv_Peak_RAM_Used_MiB/1024),
            glm_average_memory_GiB= mean(glm_Peak_RAM_Used_MiB/1024))
ngenes_df$rd=factor(ngenes_df$rd)

memory_df = reshape2::melt(average_memory, id.vars=c("grid_length","n_bins"),
                                                     variable.name=c("describe"))
memory_df$type =sub(memory_df$describe, pattern="_average_memory_GiB",replacement="")
memory_df$label = memory_df$type
memory_df[memory_df$label=="sv","label"] = "build spatial vectors"
memory_df[memory_df$label=="glm","label"] = "build linear model"
memory_df$label = factor(memory_df$label, 
                         levels = c("build spatial vectors","build linear model"))
p2<- ggplot(memory_df, aes(x = n_bins, y = value, color=label)) +
    geom_point(size = 2) +
    #geom_smooth(method = "lm",se = FALSE, color = "steelblue")+
    theme_classic() +
    #scale_y_continuous(limits =c(0,80), labels = seq(0,80,10), breaks =seq(0,80,10) )+
    scale_x_continuous(limits = c(100, 10000),
                       breaks=c(100,seq(1000, 10000, 1000)),
                      labels=as.character(c(100,seq(1000, 10000, 1000))))+
   # scale_x_continuous(breaks = seq(10, 100, 10),
   #                    labels=paste(seq(10, 100, 10),"x",seq(10, 100, 10), sep=""))+
    labs(title = "Memory usage",  x = expression("Square bin length"), 
         y = "Average Peak Memory (GiB)", color="") +
    theme(axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=0.9),
          axis.title.x = element_text(size=15),          
          legend.position = "right",   
          plot.title = element_text(size = 18, face = "bold"),
          axis.text.y = element_text(size=15),
          axis.title.y = element_text(size=15))

average_times <- ntiles_df %>%
    group_by(grid_length,n_bins) %>%
  summarise(glm_average_time_min = mean(glm_Elapsed_Time_sec/60),
            sv_average_time_min = mean(sv_Elapsed_Time_sec/60) )

time_df = reshape2::melt(average_times, id.vars=c("grid_length","n_bins"),
                                                     variable.name=c("describe"))
time_df$type =sub(time_df$describe, pattern="_average_time_min",replacement="")
time_df$label=time_df$type
time_df[time_df$label=="sv","label"] = "build spatial vectors"
time_df[time_df$label=="glm","label"] = "build linear model"
time_df$label = factor(time_df$label, 
                         levels = c("build spatial vectors","build linear model"))
p1<- ggplot(time_df, aes(x = n_bins, y = value, color=label)) +
    geom_point(size = 2) +
    #geom_smooth(method = "lm",se = FALSE, color = "steelblue")+
    theme_classic() +
    #scale_y_continuous(limits =c(0,80), labels = seq(0,80,10), breaks =seq(0,80,10) )+
   # scale_x_continuous(breaks = seq(10, 100, 10),
   #                    labels=paste(seq(10, 100, 10),"x",seq(10, 100, 10), sep=""))+
    scale_x_continuous(limits = c(100, 10000),
                       breaks=c(100,seq(1000, 10000, 1000)),
                      labels=as.character(c(100,seq(1000, 10000, 1000))))+
    labs(title = "Time usage",  x = expression("Square bin length"), 
         y = "Average time (min)", color="") +
    theme(axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=0.9),
          legend.position = "none",  
          plot.title = element_text(size = 18, face = "bold"),
          axis.title.x = element_text(size=15),
          axis.text.y = element_text(size=15),
          axis.title.y = element_text(size=15))


 lyt <- p1 | p2
layout_design <-lyt + patchwork::plot_layout(heights = c(1,1), widths = c(1, 1), guides = "collect")&
    theme(legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size=15),
        legend.box.just = "center")
pdf(paste(PA, "complexity_ntiles.pdf", sep=""),width = 12, height=5)
print(layout_design)
dev.off()

```


```{r comp-ntiles}
average_times <- ntiles_df %>%
  group_by(curr_size) %>%
  summarise(average_time_min_sv = mean(time_min_sv),
            average_time_min_glm = mean(time_min_glm)) %>%
   pivot_longer(cols = c(average_time_min_sv,average_time_min_glm),
               names_to = "category",
               values_to = "avg_time",
               names_prefix = "average_time_min_")
average_times[average_times$category=="glm","category"] = "linear modelling"
average_times[average_times$category=="sv","category"] = "create spatial vectors"
average_times$category = factor(average_times$category, 
                                levels=c("create spatial vectors","linear modelling"))
average_memory <- ntiles_df %>%
  group_by(curr_size) %>%
  summarise(average_memory_sv = median(memory_MB_sv),
            average_memory_glm = median(memory_MB_glm))%>%
  pivot_longer(cols = c(average_memory_sv,average_memory_glm),
               names_to = "category",
               values_to = "avg_memory",
               names_prefix = "average_memory_")

average_memory[average_memory$category=="glm","category"] = "linear modelling"
average_memory[average_memory$category=="sv","category"] = "create spatial vectors"
average_memory$category = factor(average_memory$category, levels=c("create spatial vectors","linear modelling"))
p1<- ggplot(average_times, aes(x = curr_size, y = avg_time, color=category)) +
  geom_point(size = 2) +
  geom_line() +
  theme_classic() +
  scale_y_continuous(limits =c(0,70), labels = seq(0, 70, 10), breaks =seq(0, 70,10) )+
  scale_x_continuous(  breaks =  seq(10, 100, by=20),labels = paste(paste(seq(10, 100, by=20),"x",sep=""),seq(10, 100, by=20),sep=""))+
  labs(title = "Time usage", x = "number of tiles", y = "Average Time (min)") +
  theme(axis.text.x = element_text(size=10, angle=0, vjust=0.5),
        legend.position = "none",
        legend.title = element_blank(),
        axis.title.y = element_text(size=12),
        plot.title = element_text(size = 18, face = "bold"))

average_memory$avg_memory_GB = average_memory$avg_memory/1024
p2<- ggplot(average_memory, aes(x = curr_size, y = avg_memory_GB, color=category)) +
  geom_point(size = 2) +
  geom_line() +
  theme_classic() +
  scale_y_continuous(limits =c(0,30), labels = seq(0, 30, 5), breaks =seq(0, 30,5) )+
  scale_x_continuous( breaks =  seq(10, 100, by=20),
                      labels = paste(paste(seq(10, 100, by=20),"x",sep=""),
                                     seq(10, 100, by=20),sep=""))+
  labs(title = "Memory usage", x = "number of tiles", y = "Average Memory (GB)") +
  theme(axis.text.x = element_text(size=10, angle=0, vjust=0.5),
        legend.position = "right",
        legend.title = element_blank(),
        axis.title.y = element_text(size=12),
        plot.title = element_text(size = 18, face = "bold"))
combined_plot <- p1 +p2

layout_design <- combined_plot + plot_layout(guides = 'collect')

#pdf("discussion_cosmx_hlc_ntiles.pdf", width = 15, height=5)
print(layout_design)
#dev.off()

```

# Marker gene comparision vs number of tiles 
```{r}
# get all slurm array results for marker genes vs ntiles (xenium human breast)
result_path <- "discussion_markergenes_vs_ntiles/"
xenium_files <- list.files(path = result_path, pattern = "^xenium.*\\.csv$", full.names = TRUE)
# Read all files into a list of data frames
data_list <- lapply(xenium_files, read.csv)

keep_dfs <- lapply(data_list, function(df) df[, c(1,4,5)])
xenium_merged_df <- Reduce(function(x, y) merge(x,y,
                                         by = names(x)[1], all = TRUE), keep_dfs)
colnames(xenium_merged_df)[1] = "gene"


# get all slurm array results for marker genes vs ntiles (cosmx human liver cancer)

cosmx_files <- list.files(path = result_path, pattern = "^cosmx.*\\.csv$", full.names = TRUE)
# Read all files into a list of data frames
data_list <- lapply(cosmx_files, read.csv)

keep_dfs <- lapply(data_list, function(df) df[, c(1,4,5)])
cosmx_merged_df <- Reduce(function(x, y) merge(x,y,
                                         by = names(x)[1], all = TRUE), keep_dfs)
colnames(cosmx_merged_df)[1] = "gene"
```


## cosmx human liver cancer 
```{r}

clusters_df <- data.frame(
  cluster =paste("c", 1:13, sep=""),
  anno =c("tumor_1","tumor_2","Macrophages","T",
         "Periportal.LSECs","Stellate","B",
         "Central.venous.LSECs","Cholangiocytes","Hep",
         "Portal.endothelial",
         "NK.like","Erthyroid"),
  stringsAsFactors = FALSE
)
plt_lst = list()
for (cl in setdiff(clusters_df$cluster, c("c11","c9","c12"))){
  gr10 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr10"]==cl,"gene"]
  gr20 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr20"]==cl,"gene"]
  gr30 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr30"]==cl,"gene"]
  gr40 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr40"]==cl,"gene"]
  gr50 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr50"]==cl,"gene"]
  gr60 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr60"]==cl,"gene"]
  gr70 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr70"]==cl,"gene"]
  gr80 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr80"]==cl,"gene"]
  gr90 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr90"]==cl,"gene"]
  gr100 = cosmx_merged_df[cosmx_merged_df[,"top_cluster_gr100"]==cl,"gene"]
  
  df_mt =as.data.frame(matrix(FALSE,nrow=nrow(cosmx_merged_df),ncol=10))
  row.names(df_mt) =cosmx_merged_df$gene
 colnames(df_mt)=paste(paste(seq(10,100, by=10), "x", sep=""),
                        seq(10,100, by=10),sep="")
  df_mt[gr10,"10x10"] = TRUE
  df_mt[gr20,"20x20"] = TRUE
  df_mt[gr30,"30x30"] = TRUE
  df_mt[gr40,"40x40"] = TRUE
  df_mt[gr50,"50x50"] = TRUE
  df_mt[gr60,"60x60"] = TRUE
  df_mt[gr70,"70x70"] = TRUE
  df_mt[gr80,"80x80"] = TRUE
  df_mt[gr90,"90x90"] = TRUE
  df_mt[gr100,"100x100"] = TRUE
    anno_name = clusters_df[clusters_df$cluster==cl,"anno"]
  #pdf(paste(cl,"_xenium_upset.pdf", sep=""), height=6, width=8)
  plt_lst[[cl]] =plot(upset(df_mt,intersect=colnames(df_mt),
                wrap=TRUE, keep_empty_groups= FALSE, name="",
                themes=theme_grey(),
                stripes=upset_stripes(geom=geom_segment(size=5),colors=c('grey95', 'grey95', 'grey95')),
                sort_intersections_by ="cardinality", sort_sets= FALSE,min_degree=1,
                set_sizes = FALSE,
                sort_intersections= "descending", warn_when_converting=FALSE,
                warn_when_dropping_groups=TRUE,encode_sets=TRUE,
                matrix=(intersection_matrix()+
                    theme(axis.text.x=element_blank(),
                          panel.background = element_rect(fill="NA"),
                                                  axis.ticks = element_blank(),
                                                  axis.title = element_blank())),
                base_annotations=list('Intersection size'=(intersection_size(bar_number_threshold=1,color='grey9',fill='grey80',
                                text = list(size = 3, vjust = -0.1))+
                theme(axis.text.x = element_blank(),
                      axis.title.x = element_blank(),
                      panel.background = element_rect(fill="NA"),
                      panel.grid = element_line(color="grey90"),
                      axis.ticks.x = element_blank()))),
              width_ratio=0.5, height_ratio=0.7)+
           ggtitle(paste(anno_name,"cells"))+
               theme(
    plot.title = element_text(size = 18, face = "bold"))
         )
  #dev.off()
}  

combined_plot <- wrap_plots(plt_lst, ncol = 3)
pdf(paste(PA, "cosmx_mg_ntiles.pdf", sep=""),  height=25, width=21)
combined_plot 
dev.off()

# 
# gr_lst = seq(10,100, by=10)
# table(as.vector(apply(cosmx_merged_df[, paste("top_cluster_gr", gr_lst, sep="")], MARGIN = 1, FUN = function (x) length(unique(as.vector(x)))==1)))
# 
# zz=as.vector(apply(cosmx_merged_df[,  paste("top_cluster_gr", gr_lst, sep="")], MARGIN = 1, FUN = function (x) length(unique(as.vector(x)))==1))
# df = cosmx_merged_df[zz==FALSE,]



```

## Xenium huamn breast cancer samples
```{r}

clusters_df <- data.frame(
  cluster = c("c1", "c3", "c2", "c4", "c5", "c7", "c9", "c6", "c8"),
  anno = c("Tumor", "Macrophages", "Stromal", "Myoepithelial", "T", 
           "Endothelial", "Mast", "B", "Dendritic"),
  stringsAsFactors = FALSE
)
plt_lst = list()
#for (cl in c("c1", "c8", "c5")){
for (cl in clusters_df$cluster){
    anno_name = clusters_df[clusters_df$cluster==cl,"anno"]
  gr10 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr10"]==cl,"gene"]
  gr20 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr20"]==cl,"gene"]
  gr30 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr30"]==cl,"gene"]
  gr40 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr40"]==cl,"gene"]
  gr50 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr50"]==cl,"gene"]
  gr60 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr60"]==cl,"gene"]
  gr70 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr70"]==cl,"gene"]
  gr80 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr80"]==cl,"gene"]
  gr90 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr90"]==cl,"gene"]
  gr100 = xenium_merged_df[xenium_merged_df[,"top_cluster_gr100"]==cl,"gene"]
  
  df_mt =as.data.frame(matrix(FALSE,nrow=nrow(xenium_merged_df),ncol=10))
  row.names(df_mt) =xenium_merged_df$gene
  colnames(df_mt)=paste(paste(seq(10,100, by=10), "x", sep=""),
                        seq(10,100, by=10),sep="")
  df_mt[gr10,"10x10"] = TRUE
  df_mt[gr20,"20x20"] = TRUE
  df_mt[gr30,"30x30"] = TRUE
  df_mt[gr40,"40x40"] = TRUE
  df_mt[gr50,"50x50"] = TRUE
  df_mt[gr60,"60x60"] = TRUE
  df_mt[gr70,"70x70"] = TRUE
  df_mt[gr80,"80x80"] = TRUE
  df_mt[gr90,"90x90"] = TRUE
  df_mt[gr100,"100x100"] = TRUE
  # pdf(paste(paste(PA, anno_name,sep=""),"_gr10_100_upset_xenium_hbreast.pdf", sep=""), 
  #     height=5, width=5)
  plt_lst[[cl]] = plot(upset(df_mt,intersect=colnames(df_mt),
                wrap=TRUE, keep_empty_groups= FALSE, name="",
                themes=theme_grey(),
                stripes=upset_stripes(geom=geom_segment(size=5),colors=c('grey95', 'grey95', 'grey95')),
                sort_intersections_by ="cardinality", sort_sets= FALSE,min_degree=1,
                set_sizes = FALSE,
                sort_intersections= "descending", warn_when_converting=FALSE,
                warn_when_dropping_groups=TRUE,encode_sets=TRUE,
                matrix=(intersection_matrix()+
                    theme(axis.text.x=element_blank(),
                          panel.background = element_rect(fill="NA"),
                                                  axis.ticks = element_blank(),
                                                  axis.title = element_blank())),
                base_annotations=list('Intersection size'=(intersection_size(bar_number_threshold=1,color='grey9',fill='grey80',
                                text = list(size = 3, vjust = -0.1))+
                theme(axis.text.x = element_blank(),
                      axis.title.x = element_blank(),
                      panel.background = element_rect(fill="NA"),
                      panel.grid = element_line(color="grey90"),
                      axis.ticks.x = element_blank()))),
              width_ratio=0.5, height_ratio=0.7)+
           ggtitle(paste(anno_name,"cells"))+theme(
    plot.title = element_text(size = 18, face = "bold")
  )
         )
# dev.off()
}  
combined_plot <- wrap_plots(plt_lst, ncol = 3)
pdf(paste("", "xenium_mg_ntiles.pdf", sep=""), height=25, width=21)
combined_plot 
dev.off()
```


