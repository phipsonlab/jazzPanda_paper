---
title: "Cosmx human liver normal sample"
author: "Melody"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global options, include = FALSE}
options(width = 80, digits = 3) 


knitr::opts_chunk$set(cache = FALSE,echo = TRUE,prompt = FALSE, 
                      comment = NA,message = FALSE,warning = FALSE,
                      fig.align = "center", fig.keep= "all",fig.show ="hold")
# w_x[2] - w_x[1] --> 10726
# w_y[2] - w_y[1] --> 8142
```

```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(gridExtra)
library(matrixStats)
library(patchwork)
library(pheatmap)
library(RColorBrewer)
library(reshape2)
library(jazzPanda)
library(tidyr)
library(dplyr)
library(corrplot)
library(edgeR)
library(ComplexUpset)
library(httr)
library(jsonlite)
library(xtable)
library(limma)
library(speckle)
```

```{r}
# calculate peak memory
PEAK_MEM_ID=which(colnames(gc())=="max used")
PEAK_MEM_MB = PEAK_MEM_ID+1

# figure path 
PA = "figures/main/figure2_cosmx_hliver/"

# theme setting for figures
defined_theme <- theme(#axis.text.x= element_text(size=8,vjust=1,hjust = 1),
                      strip.text = element_text(size = rel(1)),
                      axis.line=element_blank(),
                      axis.ticks=element_blank(),
                      axis.text=element_blank(),
                      legend.position = "none",
                      #axis.title=element_text(size=15, face="bold"),
                      axis.title=element_blank(),
                      panel.background=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank())
```
# load data 
## load count matrix and cells coordiantes 
```{r load-cm}


seu <- readRDS("/vast/projects/xenium_5k/data/cosmx_hliver/LiverDataReleaseSeurat_newUMAP.RDS")


# local cell metadata   
metadata <- as.data.frame(seu@meta.data)
cat("Number of cells in cancer and normal samples: ",nrow(metadata))
## remove low quality cells
qc_cols <- c("qcFlagsRNACounts", "qcFlagsCellCounts", "qcFlagsCellPropNeg",
             "qcFlagsCellComplex", "qcFlagsCellArea","qcFlagsFOV")
metadata <- metadata[!apply(metadata[, qc_cols], 1, function(x) any(x == "Fail")), ]

cat("Total number of cells remaining after removing low quality cells: ", nrow(metadata))

cell_info_cols = c("x_FOV_px", "y_FOV_px", "x_slide_mm", "y_slide_mm",
                   "nCount_negprobes","nFeature_negprobes","nCount_falsecode",
                   "nFeature_falsecode","slide_ID_numeric", "Run_Tissue_name",
                   "fov","cellType","niche","cell_id")
cellCoords <- metadata[, cell_info_cols]
gc(reset = TRUE)
load_cell_imem <- sum(gc()[, PEAK_MEM_MB])
# keep cancer tissue only 
liver_normal = cellCoords[cellCoords$slide_ID_numeric==1 ,]
load_cell_fmem <- sum(gc()[, PEAK_MEM_MB])
load_cell_dmem <- load_cell_fmem - load_cell_imem

cat("loading cell coordinates data for",
    nrow(cellCoords[cellCoords$Run_Tissue_name=="NormalLiver",]),"cells took",
    round(load_cell_dmem / (1024),5),"GB memory")
  

# load count matrix 
counts <-seu[["RNA"]]@counts
normal_cells = row.names(liver_normal)

gc(reset = TRUE)
load_cm_imem <- sum(gc()[, PEAK_MEM_MB])

counts_normal_sample = counts[, normal_cells]

load_cm_fmem <- sum(gc()[, PEAK_MEM_MB])
load_cm_dmem <- load_cm_fmem - load_cm_imem
rm(counts)
cat("loading count matrix data for",nrow(counts_normal_sample),"genes and",
    ncol(counts_normal_sample),"cells took",round(load_cm_dmem / (1024),5),"GB memory")

dim(counts_normal_sample)



px_to_mm <- function(data){
    all_fv = unique(data$fov)
    parm_df = as.data.frame(matrix(0, ncol=5, nrow=length(all_fv)))
    colnames(parm_df) = c("fov","y_slope","y_intcp","x_slope","x_intcp")
    parm_df$fov = all_fv
    for (fv in all_fv){
        curr_fov = data[data$fov == fv, ] 
        curr_fov = curr_fov[order(curr_fov$x_FOV_px), ]
        curr_fov = curr_fov[c(1, nrow(curr_fov)), ]
        curr_fov = curr_fov[c(1,2),c("y_slide_mm","x_slide_mm","y_FOV_px","x_FOV_px") ]
        # mm to px for y
        y_slope = (curr_fov[2,"y_slide_mm"] - curr_fov[1,"y_slide_mm"]) / (curr_fov[2,"y_FOV_px"] - curr_fov[1,"y_FOV_px"])
        y_intcp = curr_fov[2,"y_slide_mm"]- (y_slope*curr_fov[2,"y_FOV_px"])
        # mm to px for x
        x_slope = (curr_fov[2,"x_slide_mm"] - curr_fov[1,"x_slide_mm"]) / (curr_fov[2,"x_FOV_px"] - curr_fov[1,"x_FOV_px"])
        x_intcp = curr_fov[2,"x_slide_mm"]- (x_slope*curr_fov[2,"x_FOV_px"])
        parm_df[parm_df$fov==fv,"y_slope"] = y_slope
        parm_df[parm_df$fov==fv,"y_intcp"] = y_intcp
        parm_df[parm_df$fov==fv,"x_slope"] = x_slope
        parm_df[parm_df$fov==fv,"x_intcp"] = x_intcp
    }
    return (parm_df)

}

# number of cells per fov
# fov 21 contains 1 cell only 
fov_summary = as.data.frame(table(cellCoords[cellCoords$slide_ID_numeric==1,"fov"]))


# caculate the slope and intercept parameters for each fov 
parm_df = px_to_mm(liver_normal)

# convert px to mm for eeach cell based on the calculated params 
liver_normal <- liver_normal %>%
    left_join(parm_df, by = 'fov') %>%
    mutate(
      x_mm = x_FOV_px * x_slope + x_intcp,
      y_mm = y_FOV_px * y_slope + y_intcp
    ) %>%
    select(-x_slope, -y_slope, -x_intcp, -y_intcp) 


```

## load transcript coordinates
```{r load-tr}

transcriptCoords <-seu@misc$transcriptCoords

gc(reset = TRUE)
load_tr_imem <- sum(gc()[, PEAK_MEM_MB])

all_transcripts_normal <- transcriptCoords[transcriptCoords$slideID == 1,]
# remove 76 transcripts from fov21
all_transcripts_normal <- all_transcripts_normal[all_transcripts_normal$cell_id %in% liver_normal$cell_id, ]

#all_transcripts_normal = all_transcripts_normal[all_transcripts_normal$fov!=21,]

load_tr_fmem <- sum(gc()[, PEAK_MEM_MB])
load_tr_dmem <- load_tr_fmem - load_tr_imem
rm(transcriptCoords)
cat("loading transcript coordinates data for",nrow(counts_normal_sample),"genes and",
    ncol(counts_normal_sample),"cells took",round(load_tr_dmem / (1024),5),"GB memory")

all_transcripts_normal <- all_transcripts_normal %>%
    left_join(parm_df, by = 'fov') %>%
    mutate(
      x_mm = x_FOV_px * x_slope + x_intcp,
      y_mm = y_FOV_px * y_slope + y_intcp
    ) %>%
    select(-x_slope, -y_slope, -x_intcp, -y_intcp) 

all_transcripts_normal$x = all_transcripts_normal$x_mm
all_transcripts_normal$y = all_transcripts_normal$y_mm
all_transcripts_normal$feature_name = all_transcripts_normal$target

hl_normal = all_transcripts_normal[,c("x","y","feature_name")]
all_genes = row.names(seu[["RNA"]]@counts)

rm(all_transcripts_normal)
hl_normal$x = hl_normal$x * 1000
hl_normal$y = hl_normal$y * 1000
```

## load negative control coordinates

```{r,negprobes, fig.width=10, fig.height=2}
negprobes_coords <- hl_normal[grepl("^NegPrb", hl_normal$feature_name), ]
falsecode_coords <- hl_normal[grepl("^FalseCode", hl_normal$feature_name), ]
```

# refine clustering 
```{r define-cluster} 
selected_cols = c("x_FOV_px", "y_FOV_px","x_slide_mm", "y_slide_mm", "slide_ID_numeric", "Run_Tissue_name", "fov","cellType","niche","cell_id" )
clusters_info = liver_normal[,selected_cols ]
# [1] "x_FOV_px"         "y_FOV_px"         "x_slide_mm"       "y_slide_mm"       "slide_ID_numeric"
# [6] "Run_Tissue_name"  "fov"   
colnames(clusters_info) =c("x_FOV_px","y_FOV_px" , "x", "y", "slide_ID_numeric", "Run_Tissue_name", "fov","cellTypes","niche","cell_id")
clusters_info$cluster = as.character(clusters_info$cellTypes)
clusters_info[clusters_info$cellTypes %in% c("Antibody.secreting.B.cells", "Mature.B.cells"),"cluster"] = "B"
clusters_info[clusters_info$cellTypes %in% c("CD3+.alpha.beta.T.cells", "gamma.delta.T.cells.1"),"cluster"] = "T"
clusters_info[clusters_info$cellTypes %in% c("Non.inflammatory.macrophages", "Inflammatory.macrophages"),"cluster"] = "Macrophages"
# clusters_info[clusters_info$cellTypes %in% c("Hep.3","Hep.4", "Hep.5","Hep.6"),"cluster"] = "Hep3"
ig_clusters = c("NotDet")

clusters_info = clusters_info[clusters_info$cluster != "NotDet",]
clusters_info$cluster = factor(clusters_info$cluster)
#clusters_info$cell_id = row.names(clusters_info)
clusters_info$sample = "normal"
# dim = 332873     11
clusters_info = clusters_info[!duplicated(clusters_info[,c("x","y")]),]
clusters_info$x = clusters_info$x * 1000
clusters_info$y = clusters_info$y * 1000
# dim = 329616 11
# duplicated 3169 rows
table(clusters_info$cluster)/1600
cluster_names = c( "B", "Central.venous.LSECs", "Cholangiocytes", "Erthyroid.cells", 
                   "Hep.1", "Hep.3", "Hep.4", "Hep.5", "Hep.6", "Macrophages",
                   "NK.like.cells", "Periportal.LSECs", "Portal.endothelial.cells", 
                   "Stellate.cells", "T")  

clusters_info$cluster = factor(clusters_info$cluster, levels = cluster_names)


my_colors<- c(
  "#800000", "#f032e6","#ffe119", "#e6beff",
    "#e6194b", "#008080", "#0082c8", "#3cb44b",
  "#aa6e28", "#fabebe", "#d2f53c", "#911eb4",
  "#fffac8", "#f58231", "#46f0f0"
)
```

## Limma
```{r lm_workflow}
limma_st = Sys.time()
gc(reset = TRUE)
limma_imem <-sum(gc()[, PEAK_MEM_MB])

y <- DGEList(counts_normal_sample[, clusters_info$cell_id])
y$genes <-row.names(counts_normal_sample)

logcounts <- speckle::normCounts(y,log=TRUE,prior.count=0.1)
maxclust <- length(unique(clusters_info$cluster))

grp <- clusters_info$cluster

design <- model.matrix(~0+grp)
colnames(design) <- levels(grp)

mycont <- matrix(NA,ncol=length(levels(grp)),nrow=length(levels(grp)))
rownames(mycont)<-colnames(mycont)<-levels(grp)
diag(mycont)<-1
mycont[upper.tri(mycont)]<- -1/(length(levels(factor(grp)))-1)
mycont[lower.tri(mycont)]<- -1/(length(levels(factor(grp)))-1)

fit <- lmFit(logcounts,design)
fit.cont <- contrasts.fit(fit,contrasts=mycont)
fit.cont <- eBayes(fit.cont,trend=TRUE,robust=TRUE)

#treat_res <- treat(fit.cont,lfc=0.5)
limma_dt<-decideTests(fit.cont)

summary(limma_dt)

limma_fmem <-sum(gc()[, PEAK_MEM_MB])
limma_dmem <- limma_fmem - limma_imem
limma_ed = Sys.time()
limma_time=difftime(limma_ed, limma_st, units = "mins")
cat("limma took",limma_time ,"mins and",
    round(limma_dmem / (1024),5),"GB memory")

rm(y, logcounts,fit, mycont)
limma_summary = as.data.frame(summary(limma_dt))
limma_summary = limma_summary[limma_summary$Var1=="Up",c(2,3)]
colnames(limma_summary) = c("cluster","limma")


saveRDS(limma_dt, "cosmx_hhliver_limma_dt.Rds")
```

## FindMarkers
```{r fm_workflow}
fm_st = Sys.time()
gc(reset = TRUE)
fm_imem <-sum(gc()[, PEAK_MEM_MB])

hln_seu=CreateSeuratObject(counts = counts_normal_sample, project = "hl_normal")
Idents(hln_seu) = clusters_info[match(colnames(hln_seu), 
                                      clusters_info$cell_id),"cluster"]
hln_seu = NormalizeData(hln_seu, verbose = FALSE,
                        normalization.method = "LogNormalize")
hln_seu = FindVariableFeatures(hln_seu, selection.method = "vst", 
                                nfeatures = 1000, verbose = FALSE)

hln_seu=ScaleData(hln_seu, verbose = FALSE)
seu_markers <- FindAllMarkers(hln_seu, only.pos = TRUE,logfc.threshold = 0.25)
saveRDS(hln_seu, "cosmx_hhliver_hln_seu.Rds")
fm_fmem <-sum(gc()[, PEAK_MEM_MB])
fm_dmem <- fm_fmem - fm_imem
fm_ed = Sys.time()
fm_time = difftime(fm_ed, fm_st, units = "mins")
cat("FindMarkers took", fm_time,"mins and",
    round(fm_dmem / (1024),5),"GB memory")


table(seu_markers$cluster)

markers = seu_markers
top_markers <- split(markers, markers$cluster)
top_markers <- lapply(top_markers, head, n=3)
top_markers <- do.call("rbind", top_markers)
as.data.frame(top_markers)


saveRDS(seu_markers, "cosmx_hhliver_seu_markers.Rds")
```


# Figure 2(c) UMAP
```{r cluster-xy-umap, fig.width=10, fig.height=10}

set.seed(189)
Idents(seu) = seu$slide_ID_numeric
# Subset on a value in the object meta data
hhliver_seu = subset(x = seu,idents =1)
hhliver_seu = subset(x = hhliver_seu, cells = clusters_info$cell_id)
Idents(hhliver_seu) = clusters_info$cluster[match(hhliver_seu$cell_id, 
                                                  clusters_info$cell_id)]
hhliver_seu <- RunUMAP(object = hhliver_seu, dims = 1:10)


jpeg(paste(PA, "figure2c_cosmx_hhliver_UMAP.jpg", sep=""),
     height = 1000, width = 1000, res=200)
DimPlot(hhliver_seu, reduction = "umap" )+  ggtitle("") +
   labs(title = " ", x = "UMAP1", y = "UMAP2", fill=" ") +

  theme(
      legend.position = "none",
    panel.border = element_blank(), 
    panel.grid = element_blank(),
    panel.background = element_blank(),axis.title = element_text(size=12)
  ) 
dev.off()

```

# Figure 2(a)
```{r}

sum_df = clusters_info[,c("cluster", "cellTypes","sample"),drop=FALSE] %>%
    group_by(cluster,sample) %>% dplyr::count()
sum_df$cluster = factor(sum_df$cluster, levels = cluster_names)
pdf(paste(PA, "figure2a_cosmx_hln_celltype_prop.pdf", sep=""), width=6, height=10)
ggplot(sum_df, aes(x = sample, y = n, fill=cluster)) +
  geom_bar( stat="identity",position="fill") +
  scale_y_continuous(labels = scales::percent)+
  labs(title = " ", x = " ", y = "proportion of cell types", fill="cell types") +

     scale_fill_manual(values =my_colors)+
   theme(legend.position = "right",axis.text.x= element_blank(),
         legend.text = element_text(size =12),
          axis.line=element_blank(),
               axis.text.y=element_blank(),axis.ticks=element_blank(),
               axis.title.x=element_blank(),
               axis.title.y=element_blank(),
               panel.background=element_blank(),
               panel.grid.major=element_blank(),
               panel.grid.minor=element_blank(),
         plot.background=element_blank())
dev.off()
```
# Figure 2(b)
```{r cluster-xy, fig.width=10, fig.height=10}
p1<-ggplot(data = clusters_info,
        aes(x = x, y = y, color=cluster))+
        geom_point(size=0.0001, alpha=0.5)+
    
        scale_color_manual(values =my_colors)+
        #facet_wrap(~sample)+
        theme_classic()+
        guides(color=guide_legend(title="", nrow = 2,
        override.aes=list(alpha=1, size=6)))+
        defined_theme+theme(legend.position = "none",
                            strip.text = element_blank())

jpeg(paste(PA, "figure2b_cosmx_hhliver_cluster_xy.jpg", sep=""),
     height = 1600, width = 2000, res=200)
p1
dev.off()

```

# Detect marker genes 
## jazzPanda
### permutation approach
```{r mg-perm}
grid_length = 40
seed_number=589
set.seed(seed_number)
# 
# perm_p = jazzPanda::compute_permp(x=list("normal"=hl_normal),
#                         cluster_info=clusters_info, 
#                         perm.size=5000,
#                         bin_type="square",
#                         bin_param=c(grid_length,grid_length),
#                         test_genes=row.names(counts_normal_sample), 
#                         correlation_method = "spearman", 
#                         n_cores=5, 
#                         correction_method="BH")
# saveRDS(perm_p, "cosmx_hln_perm_lst.Rds")

perm_p = readRDS("cosmx_hln_perm_lst.Rds")
perm_res = get_perm_adjp(perm_p)
obs_corr = get_cor(perm_p)
head(perm_res)

jazzPanda_perm = as.data.frame(matrix(0, nrow=ncol(obs_corr), ncol=2))
colnames(jazzPanda_perm) = c("cluster","jazzPanda_correlation")
jazzPanda_perm$cluster = colnames(obs_corr)
for (cl in cluster_names){
    cl_ids =  which(cluster_names == cl)
    obs_cutoff = quantile(obs_corr[, cl], 0.75)
    perm_cl=intersect(row.names(perm_res[perm_res[,cl]<0.05,]),
                     row.names(obs_corr[obs_corr[, cl]>obs_cutoff,]))
    jazzPanda_perm[jazzPanda_perm$cluster==cl,"jazzPanda_correlation"] = length(perm_cl)
}

```

# create spatial vectors based on count matrix and cell coordiantes 
```{r create-sv}

gc(reset = TRUE)
sv_st = Sys.time()
sv_imem <- sum(gc()[, PEAK_MEM_MB])

hliver_vector_lst = get_vectors(x=list("normal"=hl_normal),
                                sample_names = "normal",
                                cluster_info = clusters_info,
                                bin_type="square",
                                bin_param=c(40,40), 
                                test_genes = all_genes,
                                n_cores = 5)
sv_ed= Sys.time()
sv_fmem <-sum(gc()[, PEAK_MEM_MB])
sv_dmem <- sv_fmem - sv_imem
sv_time = difftime(sv_ed,sv_st, units = "mins")
cat("creating vectors for",nrow(counts_normal_sample),"genes and",
    length(unique(clusters_info$cluster)),"clusters took", sv_time,"mins and",
    round(sv_dmem / (1024),5),"GB memory")

saveRDS(hliver_vector_lst,"hliver_normal_sq40_hliver_vector_lst.Rds")



#########

falsecode_coords$sample = "normal"
negprobes_coords$sample = "normal"
kpt_cols = c("x","y","feature_name","sample")
# nc_lst = list(trans_info = rbind(falsecode_coords[,kpt_cols],
#                                         negprobes_coords[,kpt_cols]))
nc_coords = rbind(falsecode_coords[,kpt_cols],negprobes_coords[,kpt_cols])


falsecode_names = unique(falsecode_coords$feature_name)
negprobe_names = unique(negprobes_coords$feature_name)
nc_vectors = create_genesets(x=list("normal"=nc_coords),
                             sample_names = "normal",
                            name_lst=list(falsecode=falsecode_names,
                                        negprobe=negprobe_names),
                            bin_type="square",
                            bin_param=c(grid_length, grid_length),
                            cluster_info=NULL)
set.seed(589)
gc(reset = TRUE)
glm_st = Sys.time()
glm_imem <-sum(gc()[, PEAK_MEM_MB])

jazzPanda_res_lst = lasso_markers(gene_mt=hliver_vector_lst$gene_mt,
                                    cluster_mt = hliver_vector_lst$cluster_mt,
                                    sample_names=c("normal"),
                                    keep_positive=TRUE, 
                                    background=nc_vectors,
                                    n_fold = 10)

glm_fmem <- sum(gc()[, PEAK_MEM_MB])
glm_ed <- Sys.time()
glm_dmem <- glm_fmem - glm_imem
glm_time <- difftime(glm_ed, glm_st, units = "mins")
cat("jazzPanda-linear model took", glm_time,"mins and",
    round(glm_dmem / (1024),5),"GB memory")

jazzPanda_res=get_top_mg(jazzPanda_res_lst, coef_cutoff=0.2)  
table(jazzPanda_res$top_cluster)
head(jazzPanda_res)


jazzPanda_summary = as.data.frame(table(jazzPanda_res$top_cluster))
colnames(jazzPanda_summary) = c("cluster","jazzPanda_glm")
```


# Figure 2(d) 
## spatial coordinates for one cluster
```{r}
cl = "Stellate.cells"
p_cl<- ggplot(data = clusters_info[clusters_info$cluster==cl, ],
        aes(x = x, y = y))+ 
        facet_wrap(~cluster)+
        #geom_hex(bins = 120)+
        geom_point(size=0.01, alpha=0.1,color="#f58231")+
        guides(fill = guide_colorbar(height= unit(0.6, "cm")))+
        scale_fill_gradient(low="white", high="black") + 
        #scale_fill_gradient(low="white", high="maroon4") + 
        defined_theme+ 
        theme(legend.position = "bottom",
              strip.background = element_rect(colour = "white", 
                                              fill = "white", 
                                              linetype = "solid"), 
              panel.border = element_rect(colour = "NA", fill="NA"),
               strip.text = element_text(size = 15),
              panel.spacing = unit(0, "lines"))


jpeg(paste(PA, "figure2d_cosmx_hhliver_stellate_xy.jpg", sep=""),
      height = 1000, width = 1100, res=200)
p_cl 
dev.off()
```
# Figure 2(e) 
## spatial coordinates for top marker gene
```{r top3-gene-vis-xy-perm, fig.width=10, fig.height=12}

cl_hex = c(80,  90, 150,  100, 200, 300, 300,  200, 300, 100, 100, 200, 100, 120, 100)
tr_hex = c(100, 160, 120, 200, 1000, 100, 400,   400, 200, 100, 200, 80, 80, 100, 100)
cl = "Stellate.cells"

obs_cutoff = quantile(obs_corr[, cl], 0.75)
perm_cl=intersect(row.names(perm_res[perm_res[,cl]<0.05,]),
                 row.names(obs_corr[obs_corr[, cl]>obs_cutoff,]))
inters=perm_cl
#inters=jazzPanda_res[jazzPanda_res$top_cluster==cl,"gene"]
rounded_val=signif(as.numeric(obs_corr[inters,cl]), digits = 3)
inters_df = as.data.frame(cbind(gene=inters, value=rounded_val))
inters_df$value = as.numeric(inters_df$value)
inters_df=inters_df[order(inters_df$value, decreasing = TRUE),]
inters = inters_df$gene[1]
iters_sp1=hl_normal[hl_normal$feature_name %in%  inters,]
vis_r1 =iters_sp1[,c("x","y","feature_name")]
p1<- ggplot(data = vis_r1,
            aes(x = x, y = y))+ 
            #geom_hex(bins = tr_hex[cl_ids])+
            geom_point(size=0.01, alpha=0.1)+
            facet_wrap(~feature_name, scales="free", ncol=3)+
            scale_fill_gradient(low="white", high="maroon4") + 
            guides(fill = guide_colorbar(height= unit(0.6, "cm")))+
            defined_theme+  theme(legend.position = "bottom",
              strip.background = element_rect(colour = "white", 
                                              fill = "white", 
                                              linetype = "solid"), 
              panel.border = element_rect(colour = "NA", fill="NA"),
              strip.text = element_text(size = 15),
              panel.spacing = unit(0, "lines"))


jpeg(paste(PA, "figure2e_cosmx_hhliver_top1_xy_perm.jpg", sep=""),
     height = 1000, width = 1100, res=200)
p1
dev.off()
```
# Figure 2(f) 

```{r}

hliver_vector_lst= readRDS("hliver_normal_sq40_hliver_vector_lst.Rds")
cl = "Stellate.cells"
mk_gene ="IGFBP7"
perm_res[mk_gene,cl]
obs_corr[mk_gene,cl]
dff = as.data.frame(cbind(hliver_vector_lst$cluster_mt[,cl],
                        hliver_vector_lst$gene_mt[,mk_gene]))
colnames(dff) = c("cluster", mk_gene)
dff$vector_id = c(1:(grid_length*grid_length))
long_df <- dff %>% 
         pivot_longer(cols = -c(cluster, vector_id), names_to = "gene", 
                       values_to = "vector_count")
long_df$gene = factor(long_df$gene, levels=mk_gene)

p<-ggplot(long_df, aes(x = cluster, y = vector_count, color =gene )) +
geom_point(color="black", size=0.01) +
facet_wrap(~gene, scales = "free_y", nrow=1) +
labs(x = paste(cl, " cluster vector ", sep=""), y = "IGFBP7 gene vector") +
theme_minimal()+
    scale_y_continuous(expand = c(0.01,0.01))+ 
    scale_x_continuous(expand =  c(0.01,0.01))+ 
theme(panel.grid = element_blank(),legend.position = "none",
    strip.text = element_blank(),#element_text(size = rel(1)),
    axis.line=element_blank(),
    axis.text=element_text(size = 12),
    axis.ticks=element_line(color="black"),
    axis.title=element_text(size = 15),
    panel.border  =element_rect(colour = "black", fill=NA, linewidth=0.5)
    )

pdf(paste(PA, "figure2f_cosmx_hhliver_top1_perm_vvplot.pdf", sep=""),
      height = 5, width = 5)
p
dev.off()
```

